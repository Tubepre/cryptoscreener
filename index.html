<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OKX USDT Perpetual Screener</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h1>OKX USDT Perpetual Screener</h1>
  <div id="gain-table">Loading gainers...</div>
  <div id="lose-table">Loading losers...</div>

  <script>
    let okxCoins = [];
    let coinGeckoData = {};

    // Fetch OKX USDT Perpetual (SWAP) tickers
    fetch('https://www.okx.com/api/v5/market/tickers?instType=SWAP')
      .then(res => res.json())
      .then(data => {
        okxCoins = data.data.filter(c => c.instId.endsWith('USDT-SWAP'));
        fetchCoinGecko();
      });

    // Fetch CoinGecko market data
    function fetchCoinGecko() {
      fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&per_page=250&page=1')
        .then(res => res.json())
        .then(data => {
          data.forEach(coin => {
            coinGeckoData[coin.symbol.toUpperCase()] = coin;
          });
          processAndDisplay();
        });
    }

    function processAndDisplay() {
      const combined = okxCoins.map(c => {
        const symbol = c.instId.split('-')[0]; // e.g. BTC from BTC-USDT-SWAP
        const gecko = coinGeckoData[symbol];

        if (gecko) {
          return {
            symbol: symbol,
            price: parseFloat(c.last),
            change: gecko.price_change_percentage_24h || 0
          };
        }
      }).filter(Boolean);

      const sorted = combined.sort((a, b) => b.change - a.change);
      const topGainers = sorted.slice(0, 10);
      const topLosers = sorted.slice(-10).reverse();

      displayTable(topGainers, "Top 10 Gainers", "gain-table");
      displayTable(topLosers, "Top 10 Losers", "lose-table");
    }

    function displayTable(data, title, containerId) {
      let html = `<h2>${title}</h2>`;
      html += `<table>
        <tr><th>Symbol</th><th>Price</th><th>24h Change (%)</th></tr>`;
      data.forEach(item => {
        html += `<tr>
          <td>${item.symbol}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td style="color:${item.change >= 0 ? 'green' : 'red'}">${item.change.toFixed(2)}%</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById(containerId).innerHTML = html;
    }
  </script>
</body>
</html>
